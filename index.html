<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Newbuilds</title>
    <script id="theme-loader">
      // This script runs synchronously before the page renders to prevent FOUC (Flicker of Unstyled Content).
      (function() {
        try {
          const DEFAULT_THEME = 'golf';
          const assignmentsKey = 'pageThemeAssignments';
          const base = '/newbuilds/'; // Must match vite.config.ts base path

          // Normalize the current browser path to match the path stored in localStorage.
          // In prod, pathname is /newbuilds/some/path, we need /some/path.
          // In dev, pathname is /some/path, which is already correct.
          let currentPath = window.location.pathname;
          if (currentPath.startsWith(base)) {
            currentPath = currentPath.substring(base.length);
            if (!currentPath.startsWith('/')) {
                currentPath = '/' + currentPath;
            }
          }
          // Normalize trailing slash for comparison.
          if (currentPath.length > 1 && currentPath.endsWith('/')) {
              currentPath = currentPath.slice(0, -1);
          }


          let themeToApply = DEFAULT_THEME;
          const assignmentsStr = localStorage.getItem(assignmentsKey);

          if (assignmentsStr) {
            const assignments = JSON.parse(assignmentsStr);
            const isGolfPage = path => path && path.includes('new-build-golf-properties-costa-blanca');
            
            const savedAssignment = assignments.find(a => {
              if (!a.pagePath) return false;

              // Special handling for golf pages which are grouped.
              if (isGolfPage(a.pagePath) && isGolfPage(currentPath)) {
                return true;
              }

              // Normalize stored path for comparison.
              let storedPath = a.pagePath;
              if (storedPath.length > 1 && storedPath.endsWith('/')) {
                  storedPath = storedPath.slice(0, -1);
              }
              
              return storedPath === currentPath;
            });

            if (savedAssignment && savedAssignment.themeId) {
              themeToApply = savedAssignment.themeId;
            }
          }
          
          document.documentElement.setAttribute('data-theme', themeToApply);
        } catch (e) {
          console.error('Theme loader script failed:', e);
          // Fallback gracefully in case of any error.
          document.documentElement.setAttribute('data-theme', 'golf');
        }
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
